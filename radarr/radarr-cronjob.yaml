# apiVersion: batch/v1
# kind: CronJob
# metadata:
#   name: radarr-cronjob-tarcopy
#   namespace: radarr
# spec:
#   # schedule: "0 * * * *"
#   schedule: "*/5 * * * *"
#   successfulJobsHistoryLimit: 3
#   failedJobsHistoryLimit: 1
#   jobTemplate:
#     spec:
#       template:
#         spec:
#           containers:
#           - name: tarcopy
#             image: busybox
#             command: ["sh", "/scripts/tarcopy.sh"]
#             securityContext:
#               runAsUser: 568
#             volumeMounts:
#             - name: pvc
#               mountPath: /pvc
#             - name: nfs
#               mountPath: /nfs
#             - name: script
#               mountPath: /scripts
#           restartPolicy: OnFailure
#           volumes:
#           - name: pvc
#             persistentVolumeClaim:
#               claimName: radarr-config-pvc
#           - name: nfs
#             nfs:
#               server: 192.168.0.100
#               path: /mnt/epool/tarshots/radarr
#           - name: script
#             configMap:
#               name: radarr-cm-tarcopy
#               defaultMode: 0755
apiVersion: batch/v1
kind: CronJob
metadata:
  name: radarr-cronjob-snapshot
  namespace: radarr
spec:
  schedule: "0 0 * * *"  # This schedule runs the job once a day at midnight
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: snapshot-sa
          containers:
          - name: snapshot
            image: bitnami/kubectl:latest
            command:
            - "/bin/sh"
            - "-c"
            - |
              # Step 1: Delete the current VolumeSnapshot
              kubectl delete volumesnapshot radarr-config-snapshot -n radarr --ignore-not-found

              # Step 2: Create a new VolumeSnapshot
              kubectl apply -f - <<EOF
              apiVersion: snapshot.storage.k8s.io/v1
              kind: VolumeSnapshot
              metadata:
                name: radarr-config-snapshot
                namespace: radarr
              spec:
                volumeSnapshotClassName: rook-cephfs-snapshot-class
                source:
                  persistentVolumeClaimName: radarr-config-pvc
              EOF

              # Step 3: Wait for the new VolumeSnapshot to be ready
              while [[ $(kubectl get volumesnapshot radarr-config-snapshot -n radarr -o jsonpath='{.status.readyToUse}') != "true" ]]; do
                echo "Waiting for the VolumeSnapshot to be ready..."
                sleep 10
              done

              # Step 4: Delete the current PVC created from the snapshot
              kubectl delete pvc radarr-config-snapshot-pvc -n radarr --ignore-not-found

              # Step 5: Create a new PVC from the new VolumeSnapshot
              kubectl apply -f - <<EOF
              apiVersion: v1
              kind: PersistentVolumeClaim
              metadata:
                name: radarr-config-snapshot-pvc
                namespace: radarr
              spec:
                accessModes:
                - ReadWriteMany
                resources:
                  requests:
                    storage: 50Gi
                storageClassName: rook-cephfs
                dataSource:
                  name: radarr-config-snapshot
                  kind: VolumeSnapshot
                  apiGroup: snapshot.storage.k8s.io
              EOF
          restartPolicy: OnFailure
